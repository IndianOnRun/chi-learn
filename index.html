<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Chi-Learn</title>
        <!-- JQuery -->
        <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="viewer/css/bootstrap.css"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<!-- D3 JS -->
        <script type="text/javascript" src="viewer/d3/d3.v3.js"></script>
	</head>
	<body>
    <div class="container">
        <div class="row">
            <div id="map" class="col-md-6"></div>
            <div id="text" class="col-md-6">
                <h1>Chicago: Predicting Violent Crime</h1>
                <p> For a random sample of 1000 days between January 1, 2005 and April 10, 2015, this map
                    shows which algorithms performed best in each
                    <a href="http://en.wikipedia.org/wiki/Community_areas_in_Chicago">community area</a>.
                </p>
                <p>
                    The community areas are colored by which algorithm performed best.
                </p>
                <ul> <strong>Key:</strong>
                    <li><span class="label" style="background-color:orange">Tie For First</span></li>
                    <li><span class="label" style="background-color:green">Sequential</span></li>
                    <li><span class="label" style="background-color:blue">Non-sequential</span></li>
                    <li><span class="label" style="background-color:purple">Baseline</span></li>
                </ul>
                    <p>
                    Click on a community area to see more detail.
                </p>
                <div id="details" hidden>
                    <h2 id="clickedArea"></h2>
                    <p>Days with violent crime since 2001: <strong id="clickedRate"></strong>%</p>
                    <div id="rankings"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <h2>Algorithm Descriptions</h2>
            <p>We tested three models against each community area.</p>
            <h3>Sequential Prediction</h3>
            <p>Description of hidden Markov model</p>
            <h3>Nonsequential Prediction</h3>
            <p>Description of logistic regression</p>
            <h3>Baseline for Evaluation</h3>
            <p>Description of naive baseline</p>
        </div>
    </div>
        <!-- Bring in the numToArea object that maps from community area numbers to names -->
        <script src="viewer/js/number_to_community_area.js"></script>
        <script src="viewer/js/baseline.js"></script>
        <script src="viewer/js/rankings.js"></script>
		<script type="text/javascript">

			//Width and height
			var w = 600;
			var h = 600;

			// Create an SVG element that will hold our map
			var svg = d3.select("#map")
						.append("svg")
						.attr("width", w)
						.attr("height", h);

            // Define quantize scale to sort data values into buckets of color
			var color = d3.scale.quantize()
                                // These are shades of green used in a D3 book. They look nice.
								.range(["rgb(237,248,233)",
                                        "rgb(186,228,179)",
                                        "rgb(116,196,118)",
                                        "rgb(49,163,84)",
                                        "rgb(0,109,44)"])
                                // We are representing probabilities
                                .domain([0,1]);

            function colorFromRanking(ranking){
                if (isTieForFirst(ranking)){
                    return 'orange'
                }
                function isFirst(algorithm){
                    return ranking[algorithm] == 1;
                }
                if (isFirst('sequential')) return 'green';
                else if (isFirst('nonsequential')) return 'blue';
                else if (isFirst('baseline')) return 'purple';
                // Shouldn't get here
                else return 'pink'
            }

            function isTieForFirst(ranking){
                var numerical_ranks = [];
                for (var algorithm in ranking){
                    numerical_ranks.push(ranking[algorithm]);
                }
                return (numerical_ranks.filter(function(x){return x == 1}).length > 1)
            }

            // Load in GeoJSON data
            d3.json("viewer/json/commAreasGeo.json", function(geoJson) {

                // D3 can only bind one datum to a DOM element at a time,
                // so we need to combine the GeoJSON data and the crime data
                for (var index in geoJson.features) {
                    //console.log(index)
                    area = geoJson.features[index];
                    geoJson.features[index].name = numToAreaName[area.area_number];
                    geoJson.features[index].crimeRate = areaNumToCrimeRate[area.area_number];
                    geoJson.features[index].ranking = rankings[numToAreaName[area.area_number]];
                    //console.log(rankings[numToAreaName[area.area_number]])
                }

                // Create a view that is more or less centered on Chicago
                var projection = d3.geo.mercator().scale([343300])
                        .center([-87.68398142305401, 41.92394041])
                        .translate([250.02673254274777, 174.99268431711602]);

                // Construct a function that will convert GeoJSON coordinates to SVG path coordinates
                var projectCoordinatesToSVG = d3.geo.path().projection(projection);

                // Create an SVG path element for each datum
                svg.selectAll("path")
                    .data(geoJson.features)
                    .enter()
                    .append("path")
                    // The collision of lower-case d's is unfortunate.
                    // d defines an attribute of SVG path elements that contain points along a path.
                    // And by convention, d is used as a parameter in D3.js callbacks when referring to a datum that an element is bound to.
                    .attr("d", projectCoordinatesToSVG)
                    .style("fill", function(d){
                        return colorFromRanking(d.ranking.ranks)
                    })

                    // Add a black border to each community area
                    .style("stroke-width", "1")
                    .style("stroke", "black")

                    // On hover, highlight community areas
                    .on("mouseover", function() {
                        d3.select(this)
                        .attr("opacity", .5);
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                        .attr("opacity", 1);
                    })
                    .on("click", function(d){
                            $("#details").show();
                            $("#clickedArea").text(d.name);
                            $("#clickedRate").text(Math.round(d.crimeRate*100));
                            $("#rankings").text("");
                            var area_stats = d.ranking;
                            var alg_names = ['sequential', 'nonsequential', 'baseline'];
                            for (var i = 0; i < alg_names.length; i++) {
                                var alg_name = alg_names[i];
                                var uppercase_alg_name = alg_name.charAt(0).toUpperCase() + alg_name.slice(1);
                                $("#rankings").append("<h4>" + uppercase_alg_name + "</h4><ul>"
                                + "<li>Rank: " + area_stats.ranks[alg_name] + "</li>"
                                + "<li>Percentage of days correctly predicted: " + area_stats.accuracy[alg_name] + "%</li>")
                            }
                    })

                    // Add tooltip with community area's name
                    .append("title")
                    .text(function(d){
                        return d.name
                    });

            });

		</script>
	</body>
</html>